<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ - Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¨ØµØ±ÙŠ 2025</title>
    
    <!-- Ø±ÙˆØ§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© - Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªÙ‚Ø±Ø§Ø±Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¸Ø± -->
    <script src="www.gstatic.com"></script>
    <script src="www.gstatic.com"></script>
    <script src="www.gstatic.com"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #0f172a; color: white; text-align: center; margin: 0; padding: 10px; }
        .grid-layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; max-width: 1100px; margin: auto; }
        #video-wrap { position: relative; background: #000; border-radius: 20px; overflow: hidden; border: 4px solid #3b82f6; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        video { width: 100%; display: block; }
        .control-panel { background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid #334155; text-align: right; }
        input { width: 90%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: none; background: #0f172a; color: white; border: 1px solid #3b82f6; }
        .btn-train { background: #f59e0b; color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
        .inventory-table { background: #020617; border-radius: 12px; padding: 10px; height: 250px; overflow-y: auto; font-size: 14px; }
        .item-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #1e293b; color: #10b981; }
        #status-indicator { background: #334155; padding: 10px; border-radius: 50px; color: #fbbf24; font-size: 13px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <h2 style="color: #3b82f6;">ğŸ›’ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø¨Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ø¨ØµØ±ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø±ÙƒÙˆØ¯)</h2>
    
    <div class="grid-layout">
        <div id="video-wrap">
            <video id="webcam" autoplay playsinline muted></video>
            <div id="flash" style="position:absolute; top:0; left:0; width:100%; height:100%; background:white; opacity:0; pointer-events:none;"></div>
        </div>

        <div class="control-panel">
            <div id="status-indicator">Ø¬Ø§Ø±ÙŠ Ø´Ø­Ù† "Ø§Ù„Ù…Ø®" Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...</div>
            
            <h4>1. ØªØ¹Ø±ÙŠÙ Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h4>
            <input type="text" id="class-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù (Ù…Ø«Ù„Ø§Ù‹: Ø£Ø±Ø²)">
            <button class="btn-train" onmousedown="startTraining()" onmouseup="stopTraining()" ontouchstart="startTraining()" ontouchend="stopTraining()">
                Ø§Ø¶ØºØ· Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø± Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ø¨ØµØ±ÙŠØ©
            </button>
            <p style="font-size: 10px; color: #94a3b8;">* Ø¶Ø¹ Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ­Ø±ÙƒÙ‡ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¶ØºØ·.</p>

            <hr style="border: 0.5px solid #334155; margin: 20px 0;">

            <h4>2. Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</h4>
            <div id="inventory-list" class="inventory-table">
                <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>
            
            <button onclick="downloadReport()" style="margin-top:15px; width:100%; background:#10b981; border:none; color:white; padding:10px; border-radius:8px; cursor:pointer;">ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø±Ø¯</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const status = document.getElementById('status-indicator');
        const classNameInput = document.getElementById('class-name');
        const list = document.getElementById('inventory-list');
        
        let classifier;
        let mobilenetModel;
        let training = false;
        let inventory = {}; // { "Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù": Ø§Ù„Ø¹Ø¯Ø¯ }
        let lastDetected = "";
        let lastTime = 0;

        async function init() {
            try {
                status.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø­Ø±Ùƒ Ø¬ÙˆØ¬Ù„ (MobileNet)...";
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
                classifier = knnClassifier.create();
                mobilenetModel = await mobilenet.load();

                status.innerText = "âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²! Ø¹Ø±Ù Ù…Ù†ØªØ¬Ø§ØªÙƒ Ø§Ù„Ø¢Ù†";
                status.style.color = "#4caf50";

                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                
                detectLoop();
            } catch (err) {
                status.innerText = "âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø¬Ø±Ø¨ Ù…ØªØµÙØ­ Ø¢Ø®Ø±.";
                console.error(err);
            }
        }

        function startTraining() { 
            if (classNameInput.value === "") { alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£ÙˆÙ„Ø§Ù‹"); return; }
            training = true; 
        }
        function stopTraining() { training = false; status.innerText = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ØµÙ…Ø©! Ø¬Ø±Ø¨ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù†"; }

        async function detectLoop() {
            if (mobilenetModel) {
                const img = tf.browser.fromPixels(video);
                const activation = mobilenetModel.infer(img, 'conv_preds');

                if (training) {
                    classifier.addExample(activation, classNameInput.value);
                    if (!inventory[classNameInput.value]) inventory[classNameInput.value] = 0;
                    updateUI();
                }

                if (classifier.getNumClasses() > 0) {
                    const result = await classifier.predictClass(activation);
                    const { label, confidences } = result;

                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªØ£ÙƒØ¯Ø§Ù‹ Ø¨Ù†Ø³Ø¨Ø© Ø£ÙƒØ«Ø± Ù…Ù† 95%
                    if (confidences[label] > 0.95) {
                        handleAutoCount(label);
                    }
                }
                img.dispose();
            }
            requestAnimationFrame(detectLoop);
        }

        function handleAutoCount(label) {
            const now = Date.now();
            // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± (Ø§Ù†ØªØ¸Ø§Ø± 3 Ø«ÙˆØ§Ù†Ù Ù‚Ø¨Ù„ Ø¹Ø¯ Ù†ÙØ³ Ø§Ù„Ù‚Ø·Ø¹Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰)
            if (label !== lastDetected || (now - lastTime > 3000)) {
                inventory[label]++;
                lastDetected = label;
                lastTime = now;
                playBeep();
                updateUI();
                showFlash();
            }
        }

        function updateUI() {
            list.innerHTML = "";
            for (let name in inventory) {
                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `<span>${name}</span> <span>Ø§Ù„Ø¹Ø¯Ø¯: ${inventory[name]}</span>`;
                list.appendChild(row);
            }
        }

        function playBeep() {
            const a = new AudioContext();
            const o = a.createOscillator();
            o.connect(a.destination);
            o.start(); o.stop(a.currentTime + 0.1);
        }

        function showFlash() {
            const f = document.getElementById('flash');
            f.style.opacity = "0.5";
            setTimeout(() => f.style.opacity = "0", 100);
        }

        function downloadReport() {
            let csv = "Ø§Ù„ØµÙ†Ù,Ø§Ù„ÙƒÙ…ÙŠØ©\n";
            for(let name in inventory) csv += `${name},${inventory[name]}\n`;
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'inventory_2025.csv'; a.click();
        }

        init();
    </script>
</body>
</html>
