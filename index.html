<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ - Ù†Ø³Ø®Ø© 2025 Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
    
    <!-- Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±ÙˆØ§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø§Ù„ØªÙŠ Ù†Ø§Ø¯Ø±Ø§Ù‹ Ù…Ø§ ØªÙØ­Ø¸Ø± Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ 404 -->
    <script src="www.gstatic.com"></script>
    <script src="www.gstatic.com"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #0f172a; color: #f1f5f9; text-align: center; margin: 0; padding: 20px; }
        .main-grid { display: grid; grid-template-columns: 1fr 350px; gap: 20px; max-width: 1000px; margin: auto; }
        #video-wrap { position: relative; background: #000; border-radius: 20px; overflow: hidden; border: 3px solid #3b82f6; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        video { width: 100%; display: block; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .side-panel { background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid #334155; display: flex; flex-direction: column; }
        .inventory-table { flex-grow: 1; background: #020617; border-radius: 12px; margin-top: 15px; padding: 10px; overflow-y: auto; text-align: right; }
        .item-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #1e293b; color: #10b981; font-weight: bold; }
        #status { background: #334155; padding: 10px; border-radius: 50px; color: #fbbf24; font-size: 14px; margin-bottom: 15px; font-weight: bold; }
        .total-badge { font-size: 30px; color: #3b82f6; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h2 style="color: #3b82f6;">ğŸ›’ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ÙŠØ©</h2>
    
    <div class="main-grid">
        <div id="video-wrap">
            <video id="webcam" autoplay playsinline muted></video>
            <canvas id="overlay"></canvas>
        </div>

        <div class="side-panel">
            <div id="status">Ø¬Ø§Ø±ÙŠ Ø¥ÙŠÙ‚Ø§Ø¸ "Ø¹Ù‚Ù„" Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
            <div class="total-badge">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total-qty">0</span></div>
            
            <div style="font-size: 12px; color: #94a3b8;">Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…ÙƒØªØ´ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹:</div>
            <div id="inventory-list" class="inventory-table">
                <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
            </div>
            
            <button onclick="downloadInventory()" style="margin-top: 15px; padding: 10px; background: #10b981; border: none; color: white; border-radius: 8px; cursor: pointer;">ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø±Ø¯</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('overlay');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const list = document.getElementById('inventory-list');
        const totalQty = document.getElementById('total-qty');
        
        let model;
        let inventory = {}; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª { "Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù": Ø§Ù„Ø¹Ø¯Ø¯ }
        let lastDetected = "";
        let lastTime = 0;

        // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
        async function startApp() {
            try {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
                if (typeof cocoSsd === 'undefined') {
                    status.innerText = "âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ù…Ù† Ø¬ÙˆØ¬Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ«.";
                    return;
                }

                status.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±ØµØ¯...";
                model = await cocoSsd.load();
                status.innerText = "âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²! Ù…Ø±Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
                status.style.color = "#4caf50";

                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                
                video.onloadeddata = () => {
                    detectFrame();
                };
            } catch (err) {
                status.innerText = "Ø®Ø·Ø£: " + err.message;
            }
        }

        // 2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ±Ø³Ù… Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª ÙˆØ§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        async function detectFrame() {
            const predictions = await model.detect(video);
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            predictions.forEach(p => {
                // Ø±Ø³Ù… Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø­ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬
                ctx.strokeStyle = "#10b981";
                ctx.lineWidth = 4;
                ctx.strokeRect(...p.bbox);

                // ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…ÙƒØªØ´Ù
                ctx.fillStyle = "#10b981";
                ctx.font = "bold 18px Arial";
                ctx.fillText(p.class, p.bbox[0], p.bbox[1] > 20 ? p.bbox[1] - 10 : 20);

                // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªØ£ÙƒØ¯Ø§Ù‹ Ø¨Ù†Ø³Ø¨Ø© Ø£ÙƒØ«Ø± Ù…Ù† 60% ÙˆØ§Ù„Ù…Ù†ØªØ¬ Ø§Ø³ØªÙ‚Ø± Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                if (p.score > 0.60) {
                    processInventory(p.class);
                }
            });

            requestAnimationFrame(detectFrame);
        }

        // 3. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¹Ø¯ ÙˆØ§Ù„ÙØ±Ø² Ù„ÙƒÙ„ ØµÙ†Ù Ø¹Ù„Ù‰ Ø­Ø¯Ø©
        function processInventory(itemName) {
            const now = Date.now();
            
            // Ù†Ù…Ù†Ø¹ Ø§Ù„Ø¹Ø¯ Ø§Ù„Ù…ØªÙƒØ±Ø± Ù„Ù†ÙØ³ Ø§Ù„ØµÙ†Ù Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ù…Ø±ÙˆØ± Ø«Ø§Ù†ÙŠØªÙŠÙ† (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø®Ø·Ø£)
            if (itemName !== lastDetected || (now - lastTime > 2000)) {
                if (!inventory[itemName]) inventory[itemName] = 0;
                
                inventory[itemName]++;
                lastDetected = itemName;
                lastTime = now;
                
                playBeep();
                updateUI();
            }
        }

        function updateUI() {
            list.innerHTML = "";
            let total = 0;
            for (let name in inventory) {
                total += inventory[name];
                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `<span>${name}</span> <span>${inventory[name]}</span>`;
                list.appendChild(row);
            }
            totalQty.innerText = total;
        }

        function playBeep() {
            const a = new (window.AudioContext || window.webkitAudioContext)();
            const o = a.createOscillator();
            const g = a.createGain();
            o.connect(g);
            g.connect(a.destination);
            o.start();
            o.stop(a.currentTime + 0.1);
        }

        function downloadInventory() {
            let csv = "Ø§Ù„ØµÙ†Ù,Ø§Ù„ÙƒÙ…ÙŠØ©\n";
            for (let name in inventory) csv += `${name},${inventory[name]}\n`;
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'inventory_report.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        startApp();
    </script>
</body>
</html>
