<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ - Ù‚Ø§Ø±ÙŠØ¡ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ 2025</title>
    
    <!-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø© Tesseract Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† Ø³ÙŠØ±ÙØ± Ø¨Ø¯ÙŠÙ„ Ù…Ø³ØªÙ‚Ø± -->
    <script src="cdn.jsdelivr.net"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #0f172a; color: white; text-align: center; margin: 0; padding: 10px; }
        .jard-wrapper { max-width: 1000px; margin: auto; display: grid; grid-template-columns: 1fr 350px; gap: 15px; }
        #cam-container { position: relative; background: #000; border-radius: 20px; overflow: hidden; border: 3px solid #3b82f6; }
        video { width: 100%; display: block; }
        #scan-flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; transition: 0.1s; }
        .side-panel { background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid #334155; }
        .inventory-log { background: #020617; padding: 10px; height: 350px; overflow-y: auto; text-align: right; border-radius: 10px; border: 1px solid #334155; font-family: monospace; }
        .item-entry { color: #10b981; padding: 8px; border-bottom: 1px solid #1e293b; font-size: 14px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .status-pill { display: inline-block; padding: 5px 15px; border-radius: 50px; background: #334155; color: #fbbf24; font-size: 12px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h2 style="color: #3b82f6;">ğŸ›’ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ (Ù‚Ø§Ø±ÙŠØ¡ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)</h2>
    <div id="status" class="status-pill">Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ØµØ±ÙŠØ©...</div>

    <div class="jard-wrapper">
        <div id="cam-container">
            <video id="webcam" autoplay playsinline muted></video>
            <div id="scan-flash"></div>
            <!-- Ø¥Ø·Ø§Ø± ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ù†ØªØ¬ -->
            <div style="position:absolute; top:20%; left:10%; width:80%; height:60%; border:2px dashed #fbbf24; border-radius:10px; pointer-events:none;">
                <span style="color:#fbbf24; font-size:12px; background:rgba(0,0,0,0.5); padding:2px;">Ø¶Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù‡Ù†Ø§</span>
            </div>
        </div>

        <div class="side-panel">
            <div style="font-size: 14px; color: #94a3b8; margin-bottom: 10px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…ÙƒØªØ´ÙØ©: <b id="total-count" style="color:#10b981; font-size:20px;">0</b></div>
            <div class="inventory-log" id="log">
                <div style="color: #475569; text-align: center;">ÙˆØ¬Ù‡ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ø³Ù…Ù‡...</div>
            </div>
            <button onclick="downloadReport()" style="margin-top: 10px; width: 100%; padding: 10px; background: #10b981; border: none; color: white; border-radius: 8px; cursor: pointer;">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© ÙƒØ§Ù†ÙØ§Ø³ Ù…Ø®ÙÙŠ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± -->
    <canvas id="proc-canvas" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('webcam');
        const log = document.getElementById('log');
        const totalDisp = document.getElementById('total-count');
        const status = document.getElementById('status');
        const flash = document.getElementById('scan-flash');
        const canvas = document.getElementById('proc-canvas');
        const ctx = canvas.getContext('2d');

        let isScanning = false;
        let totalItems = 0;
        let lastDetectedText = "";

        // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø­Ø±Ùƒ
        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                status.innerText = "âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²! Ù…Ø±Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ø³Ù…Ù‡";
                
                // Ø¨Ø¯Ø¡ Ø±ØµØ¯ Ø§Ù„Ø­Ø±ÙƒØ© Ù„Ù„ØªØµÙˆÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                setInterval(detectMotionAndScan, 200);
            } catch (err) {
                status.innerText = "âŒ Ø®Ø·Ø£: ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
            }
        }

        // 2. Ø±ØµØ¯ Ø§Ù„Ø­Ø±ÙƒØ© ÙˆØ§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©
        let lastFrame;
        async function detectMotionAndScan() {
            if (isScanning) return;

            // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­Ø±ÙƒØ© (Ù†ÙØ³ ÙÙƒØ±Ø© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 48; tempCanvas.height = 36;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(video, 0, 0, 48, 36);
            const currentFrame = tempCtx.getImageData(0, 0, 48, 36).data;

            if (lastFrame) {
                let diff = 0;
                for (let i = 0; i < currentFrame.length; i += 4) {
                    diff += Math.abs(currentFrame[i] - lastFrame[i]);
                }

                if (diff > 15000) { // ØªÙ… Ø±ØµØ¯ ØªÙ…Ø±ÙŠØ± Ù…Ù†ØªØ¬
                    performOCR();
                }
            }
            lastFrame = currentFrame;
        }

        // 3. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬ (OCR)
        async function performOCR() {
            isScanning = true;
            status.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬...";
            
            // ØªØ£Ø«ÙŠØ± Ø§Ù„ÙÙ„Ø§Ø´ Ø§Ù„Ø¨ØµØ±ÙŠ
            flash.style.opacity = "0.8";
            setTimeout(() => flash.style.opacity = "0", 100);

            // Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø© Ù„Ù„Ø§Ø³Ù…
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Tesseract Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ (ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)
                const result = await Tesseract.recognize(canvas, 'ara+eng', {
                    logger: m => console.log(m)
                });

                const text = result.data.text.trim();
                
                if (text.length > 2) {
                    processDetectedItem(text);
                } else {
                    status.innerText = "âš ï¸ Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø§Ø³Ù… Ø¨ÙˆØ¶ÙˆØ­ØŒ Ø­Ø§ÙˆÙ„ Ø«Ø§Ù†ÙŠØ©";
                }
            } catch (e) {
                console.error(e);
            }

            // Ø§Ù†ØªØ¸Ø§Ø± 2 Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù…Ø³Ø­ Ù…Ù†ØªØ¬ Ø¢Ø®Ø± (Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)
            setTimeout(() => {
                isScanning = false;
                status.innerText = "âœ… Ù…Ø±Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØªØ§Ù„ÙŠ";
            }, 2000);
        }

        function processDetectedItem(rawText) {
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØºØ±ÙŠØ¨Ø©
            const cleanText = rawText.replace(/[^\w\sØ¢-ÙŠ]/gi, '').substring(0, 30);
            
            totalItems++;
            totalDisp.innerText = totalItems;
            
            playBeep();
            
            const entry = document.createElement('div');
            entry.className = 'item-entry';
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<b>[${time}]</b> ØµÙ†Ù: <span style="color:#fbbf24">${cleanText}</span>`;
            
            if (totalItems === 1) log.innerHTML = "";
            log.prepend(entry);
        }

        function playBeep() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
            osc.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function downloadReport() {
            let csv = "Ø§Ù„ÙˆÙ‚Øª,Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…ÙƒØªØ´Ù\n";
            const entries = log.querySelectorAll('.item-entry');
            entries.forEach(e => {
                const parts = e.innerText.split('] ØµÙ†Ù: ');
                csv += `${parts[0].replace('[','')},${parts[1]}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", "inventory_ocr_report.csv");
            link.click();
        }

        init();
    </script>
</body>
</html>
