<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ 2025 - Ø°Ø§ÙƒØ±Ø© Ù…Ø³ØªØ¯ÙŠÙ…Ø©</title>
    <style>
        :root { --primary: #3b82f6; --success: #10b981; --dark: #0f172a; --panel: #1e293b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--dark); color: #f1f5f9; text-align: center; margin: 0; padding: 10px; }
        .main-container { max-width: 1000px; margin: auto; display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        #video-container { position: relative; background: #000; border-radius: 20px; overflow: hidden; border: 3px solid var(--primary); }
        video { width: 100%; display: block; transform: scaleX(-1); }
        .side-panel { background: var(--panel); padding: 20px; border-radius: 20px; border: 1px solid #334155; display: flex; flex-direction: column; height: 500px; }
        .status-pill { display: inline-block; padding: 10px 20px; border-radius: 50px; background: #334155; color: #fbbf24; font-weight: bold; margin-bottom: 15px; }
        .inventory-table { background: #020617; border-radius: 12px; flex-grow: 1; overflow-y: auto; border: 1px solid #334155; }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        th { background: #1e293b; color: #94a3b8; padding: 12px; font-size: 13px; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #1e293b; color: var(--success); font-weight: bold; }
        .btn-export { background: var(--success); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; }
        tr.new-hit { animation: highlight 1s ease; }
        @keyframes highlight { from { background: #064e3b; } to { background: transparent; } }
    </style>
</head>
<body>

    <h2 style="color: var(--primary);">ğŸ›’ Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ø°ÙƒÙŠ (Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ 2025)</h2>
    <div id="app-status" class="status-pill">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <div class="main-container">
        <div id="video-container">
            <video id="webcam" autoplay playsinline muted></video>
            <div id="flash-effect" class="flash"></div>
        </div>

        <div class="side-panel">
            <div style="font-size: 14px; color: #94a3b8; margin-bottom: 10px;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©:</div>
            <div class="inventory-table">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØµÙ†Ù</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th>Ø¢Ø®Ø± Ø±ØµØ¯</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body"></tbody>
                </table>
            </div>
            <button class="btn-export" onclick="exportData()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Excel</button>
            <button onclick="resetAll()" style="background:none; border:none; color:#f43f5e; margin-top:15px; cursor:pointer; font-size:12px; text-decoration: underline;">Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØªØµÙÙŠØ± Ø§Ù„Ø¬Ø±Ø¯</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const status = document.getElementById('app-status');
        const inventoryBody = document.getElementById('inventory-body');
        const flash = document.getElementById('flash-effect');
        
        // --- ØªØ¹Ø¯ÙŠÙ„ Ø¬ÙˆÙ‡Ø±ÙŠ 1: Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ---
        let inventoryData = JSON.parse(localStorage.getItem('my_jard_2025')) || {}; 
        
        let isListening = false;
        let lastFrameData;
        let recognition;

        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                status.innerText = "âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² ÙˆÙ…ØªØµÙ„ Ø¨Ø§Ù„Ø°Ø§ÙƒØ±Ø©";
                setupVoice();
                renderTable(); // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø© ÙÙˆØ±Ø§Ù‹
                requestAnimationFrame(checkMotion);
            } catch (err) {
                status.innerText = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
            }
        }

        function setupVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ar-EG';
            
            recognition.onresult = (event) => {
                // Ø§Ù„Ø­Ù„ Ø§Ù„Ø¢Ù…Ù† Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù€ undefined ÙˆØ§Ù„Ù€ trim
                if (event.results && event.results[0] && event.results[0][0]) {
                    const itemName = event.results[0][0].transcript.trim();
                    processJard(itemName);
                }
            };
            
            recognition.onend = () => { isListening = false; status.style.background = "#334155"; };
            recognition.onerror = () => { isListening = false; status.innerText = "âš ï¸ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"; };
        }

        function checkMotion() {
            if (!isListening && video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.width = 64; canvas.height = 48;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, 64, 48);
                const currentData = ctx.getImageData(0, 0, 64, 48).data;
                if (lastFrameData) {
                    let diff = 0;
                    for (let i = 0; i < currentData.length; i += 4) diff += Math.abs(currentData[i] - lastFrameData[i]);
                    if (diff > 15000) startScan();
                }
                lastFrameData = currentData;
            }
            requestAnimationFrame(checkMotion);
        }

        function startScan() {
            if(isListening) return;
            isListening = true;
            flash.style.opacity = "0.7";
            setTimeout(() => flash.style.opacity = "0", 100);
            status.innerText = "ğŸ¤ Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„ØµÙ†ÙØŸ";
            status.style.background = "#10b981";
            try { recognition.start(); } catch(e) {}
        }

        function processJard(name) {
            const time = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø¦Ù†
            if (inventoryData[name]) {
                inventoryData[name].count++;
                inventoryData[name].lastTime = time;
            } else {
                inventoryData[name] = { count: 1, lastTime: time };
            }
            
            // --- ØªØ¹Ø¯ÙŠÙ„ Ø¬ÙˆÙ‡Ø±ÙŠ 2: Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙˆØ±Ø§Ù‹ ---
            localStorage.setItem('my_jard_2025', JSON.stringify(inventoryData));
            
            renderTable(name);
        }

        function renderTable(highlightedName = null) {
            inventoryBody.innerHTML = "";
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù„Ù…ØµÙÙˆÙØ© ÙˆØ¹Ø±Ø¶Ù‡Ø§ (Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙˆÙ‚)
            const items = Object.keys(inventoryData).reverse(); 

            items.forEach(name => {
                const row = document.createElement('tr');
                if (name === highlightedName) row.className = "new-hit";
                row.innerHTML = `
                    <td>${name}</td>
                    <td>${inventoryData[name].count}</td>
                    <td style="font-size:11px; color:#64748b;">${inventoryData[name].lastTime}</td>
                `;
                inventoryBody.appendChild(row);
            });
        }

        function resetAll() {
            if (confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                // --- ØªØ¹Ø¯ÙŠÙ„ Ø¬ÙˆÙ‡Ø±ÙŠ 3: Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ---
                localStorage.removeItem('my_jard_2025');
                inventoryData = {};
                renderTable();
                status.innerText = "â™»ï¸ ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©";
            }
        }

        function exportData() {
            let csv = "Ø§Ù„ØµÙ†Ù,Ø§Ù„ÙƒÙ…ÙŠØ©,Ø§Ù„ÙˆÙ‚Øª\n";
            Object.keys(inventoryData).forEach(name => {
                csv += `${name},${inventoryData[name].count},${inventoryData[name].lastTime}\n`;
            });
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Ø¬Ø±Ø¯_Ø§Ù„Ù…Ø­Ù„_2025.csv";
            link.click();
        }

        window.onload = init;


        // 1. Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
async function init() {
    try {
        const constraints = { 
            video: { 
                facingMode: "environment", // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©
                width: { ideal: 640 },
                height: { ideal: 480 }
            },
            audio: true // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ØµÙˆØª ØµØ±Ø§Ø­Ø©
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        // ØªØ£ÙƒÙŠØ¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ù„Ù„Ù…Ø³ Ù„Ù„Ø¬ÙˆØ§Ù„
        video.play(); 
        
        status.innerText = "âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„";
        setupVoice();
        renderTable();
        requestAnimationFrame(checkMotion);
    } catch (err) {
        status.innerText = "âŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… HTTPS ÙˆÙ…Ù†Ø­ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª";
        console.error(err);
    }
}

// 2. ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„ØµÙˆØª Ù„Ù„Ø¬ÙˆØ§Ù„
function setupVoice() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ar-EG';
    recognition.continuous = false; // Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ ÙŠÙØ¶Ù„ Ø¬Ø¹Ù„Ù‡Ø§ false ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹

    recognition.onresult = (event) => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ù„Ù„Ø¬ÙˆØ§Ù„
        if (event.results && event.results[0] && event.results[0][0]) {
            const itemName = event.results[0][0].transcript.trim();
            processJard(itemName);
        }
    };

    recognition.onend = () => {
        isListening = false;
        // Ø¥Ø°Ø§ ØªÙˆÙ‚Ù Ø§Ù„ØµÙˆØª ÙØ¬Ø£Ø©ØŒ Ù†ØºÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø±ØµØ¯ Ø¨Ø§Ù„Ø­Ø±ÙƒØ© Ù…Ø¬Ø¯Ø¯Ø§Ù‹
        status.style.background = "#334155";
    };

    recognition.onerror = (event) => {
        isListening = false;
        console.log("Error logic:", event.error);
        if(event.error === 'not-allowed') {
            status.innerText = "âŒ ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†";
        }
    };
}

    </script>
</body>
</html>

