<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة جرد المحل 2025</title>
    
    <!-- الخطة البديلة: استدعاء المكتبة من سيرفر جوجل الرسمي مباشرة بدلاً من jsdelivr -->
    <script src="www.gstatic.com" crossorigin="anonymous"></script>

    <style>
        body { font-family: sans-serif; background-color: #121212; color: white; text-align: center; padding: 20px; }
        .box { max-width: 500px; margin: auto; background: #1e1e1e; padding: 20px; border-radius: 15px; border: 1px solid #333; }
        #v-res { position: relative; width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 10px; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        button { background: #28a745; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 10px; cursor: pointer; margin-top: 20px; width: 100%; }
        button:disabled { background: #444; }
        #st { margin-top: 15px; font-size: 14px; color: #ffeb3b; }
    </style>
</head>
<body>

    <div class="box">
        <h3>نظام جرد المنتجات بالذكاء الاصطناعي</h3>
        <div id="v-res">
            <video id="web" autoplay playsinline></video>
            <canvas id="out"></canvas>
        </div>
        <button id="go" disabled>جاري التحميل...</button>
        <div id="st">تحميل المحرك من سيرفرات Google...</div>
    </div>

    <script>
        const video = document.getElementById('web');
        const canvas = document.getElementById('out');
        const ctx = canvas.getContext('2d');
        const btn = document.getElementById('go');
        const st = document.getElementById('st');
        let detector;

        async function init() {
            try {
                // التأكد من أن المكتبة تم تحميلها في الذاكرة
                const vision = window.tasksVision;
                if (!vision) throw new Error("سيرفر المكتبة محجوب لديك.");

                // استخدام سيرفر جوجل لملفات الـ WASM أيضاً
                const wasm = "www.gstatic.com";
                const res = await vision.FilesetResolver.forVisionTasks(wasm);

                detector = await vision.ObjectDetector.createFromOptions(res, {
                    baseOptions: {
                        modelAssetPath: "storage.googleapis.com",
                        delegate: "GPU"
                    },
                    scoreThreshold: 0.5,
                    runningMode: "VIDEO"
                });

                st.innerText = "متصل بنجاح! النظام جاهز.";
                st.style.color = "#4caf50";
                btn.disabled = false;
                btn.innerText = "بدء عملية الجرد الآن";
            } catch (e) {
                st.innerText = "خطأ: " + e.message + " (جرب متصفحاً آخر أو أوقف مانع الإعلانات)";
                st.style.color = "#f44336";
            }
        }

        btn.onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
            video.onloadeddata = () => {
                btn.style.display = 'none';
                predict();
            };
        };

        async function predict() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const dets = await detector.detectForVideo(video, Date.now());
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            dets.detections.forEach(d => {
                const { originX, originY, width, height } = d.boundingBox;
                ctx.strokeStyle = "#00ff00"; ctx.lineWidth = 4;
                ctx.strokeRect(originX, originY, width, height);
                ctx.fillStyle = "#00ff00"; ctx.font = "bold 20px Arial";
                ctx.fillText(d.categories[0].categoryName, originX, originY - 10);
            });
            requestAnimationFrame(predict);
        }

        window.onload = init;
    </script>
</body>
</html>
