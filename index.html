<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„ÙØ±Ø² Ø§Ù„ØªØ¬Ù…ÙŠØ¹ÙŠ 2025</title>
    <style>
        :root { --primary: #3b82f6; --success: #10b981; --dark: #0f172a; --panel: #1e293b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--dark); color: #f1f5f9; text-align: center; margin: 0; padding: 10px; }
        
        .main-container { max-width: 1000px; margin: auto; display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        
        #video-container { position: relative; background: #000; border-radius: 20px; overflow: hidden; border: 3px solid var(--primary); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        video { width: 100%; display: block; }
        
        .side-panel { background: var(--panel); padding: 20px; border-radius: 20px; border: 1px solid #334155; display: flex; flex-direction: column; }
        
        .status-pill { display: inline-block; padding: 10px 20px; border-radius: 50px; background: #334155; color: #fbbf24; font-weight: bold; margin-bottom: 15px; font-size: 14px; }
        
        /* ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ÙŠ */
        .inventory-table { background: #020617; border-radius: 12px; height: 350px; overflow-y: auto; border: 1px solid #334155; }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        th { background: #1e293b; color: #94a3b8; padding: 12px; font-size: 13px; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #1e293b; color: var(--success); font-weight: bold; font-size: 16px; }
        tr.new-hit { animation: highlight 1s ease; }
        @keyframes highlight { from { background: #064e3b; } to { background: transparent; } }

        .btn-export { background: var(--success); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <h2 style="color: var(--primary);">ğŸ›’ Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ø°ÙƒÙŠ (ÙØ±Ø² ÙˆØªØ¬Ù…ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ)</h2>
    <div id="app-status" class="status-pill">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...</div>

    <div class="main-container">
        <div id="video-container">
            <video id="webcam" autoplay playsinline muted></video>
            <div id="flash-effect" class="flash"></div>
        </div>

        <div class="side-panel">
            <div style="font-size: 14px; color: #94a3b8; margin-bottom: 10px;">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</div>
            
            <div class="inventory-table">
                <table id="results-table">
                    <thead>
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th>Ø¢Ø®Ø± Ø±ØµØ¯</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body">
                        <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                    </tbody>
                </table>
            </div>

            <button class="btn-export" onclick="exportData()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Excel</button>
            <button onclick="resetAll()" style="background:none; border:none; color:#f43f5e; margin-top:10px; cursor:pointer; font-size:12px;">ØªØµÙÙŠØ± Ø§Ù„Ø¬Ø±Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const status = document.getElementById('app-status');
        const inventoryBody = document.getElementById('inventory-body');
        const flash = document.getElementById('flash-effect');
        
        let inventoryData = {}; // Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: { "Ø£Ø±Ø²": { count: 5, lastTime: "10:00" } }
        let isListening = false;
        let lastFrameData;
        let recognition;

        // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                status.innerText = "âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²! Ù…Ø±Ø± Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù†Ø·Ù‚ Ø§Ø³Ù…Ù‡";
                setupVoice();
                requestAnimationFrame(checkMotion);
            } catch (err) {
                status.innerText = "âŒ ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
            }
        }

        // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ Ø§Ù„Ù…Ø³ØªÙ…Ø±
        function setupVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ar-EG,en-US';
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const itemName = event.results[0].transcript.trim().toLowerCase();
                processJard(itemName);
            };

            recognition.onend = () => {
                isListening = false;
                status.innerText = "âœ… Ù…Ø±Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØªØ§Ù„ÙŠ";
                status.style.background = "#334155";
            };

            recognition.onerror = () => {
                isListening = false;
                status.innerText = "âš ï¸ Ù„Ù… Ø£Ø³Ù…Ø¹ÙƒØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
            };
        }

        // 3. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø±ÙƒØ© Ø§Ù„ØªÙ…Ø±ÙŠØ±
        function checkMotion() {
            if (!isListening) {
                const canvas = document.createElement('canvas');
                canvas.width = 64; canvas.height = 48;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, 64, 48);
                const currentData = ctx.getImageData(0, 0, 64, 48).data;

                if (lastFrameData) {
                    let diff = 0;
                    for (let i = 0; i < currentData.length; i += 4) {
                        diff += Math.abs(currentData[i] - lastFrameData[i]);
                    }
                    if (diff > 12000) { // Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø±ØµØ¯
                        startScan();
                    }
                }
                lastFrameData = currentData;
            }
            requestAnimationFrame(checkMotion);
        }

        // 4. Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø³Ø­
        function startScan() {
            isListening = true;
            flash.style.opacity = "0.7";
            setTimeout(() => flash.style.opacity = "0", 100);
            
            playBeep();
            status.innerText = "ğŸ¤ Ø§Ø³Ù…Ø¹Ùƒ.. Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ";
            status.style.background = "#10b981";
            
            try { recognition.start(); } catch(e) {}
        }

        // 5. Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø°ÙƒÙŠØ© (Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¨Ù†Ø¯)
        function processJard(name) {
            const time = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            if (inventoryData[name]) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ù†Ø²ÙŠØ¯ Ø§Ù„Ø¹Ø¯Ø¯
                inventoryData[name].count++;
                inventoryData[name].lastTime = time;
            } else {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† ØµÙ†ÙØ§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ØŒ Ù†Ù†Ø´Ø¦Ù‡
                inventoryData[name] = { count: 1, lastTime: time };
            }
            
            renderTable(name); // Ù†Ù…Ø±Ø± Ø§Ù„Ø§Ø³Ù… Ù„Ø¹Ù…Ù„ ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù…Ø­Ø¯Ø«
        }

        // 6. ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
        function renderTable(highlightedName) {
            inventoryBody.innerHTML = "";
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨Ø­ÙŠØ« ÙŠØ¸Ù‡Ø± Ø£Ø­Ø¯Ø« ØµÙ†Ù ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
            const sortedItems = Object.keys(inventoryData).sort((a, b) => {
                if (a === highlightedName) return -1;
                return 0;
            });

            sortedItems.forEach(name => {
                const row = document.createElement('tr');
                if (name === highlightedName) row.className = "new-hit";
                
                row.innerHTML = `
                    <td>${name}</td>
                    <td>${inventoryData[name].count}</td>
                    <td style="font-size:11px; color:#64748b;">${inventoryData[name].lastTime}</td>
                `;
                inventoryBody.appendChild(row);
            });
        }

        function playBeep() {
            const ac = new (window.AudioContext || window.webkitAudioContext)();
            const o = ac.createOscillator();
            o.connect(ac.destination);
            o.start(); o.stop(ac.currentTime + 0.1);
        }

        function exportData() {
            let csv = "\uFEFFØ§Ù„ØµÙ†Ù,Ø§Ù„ÙƒÙ…ÙŠØ©,Ø¢Ø®Ø± ÙˆÙ‚Øª Ø±ØµØ¯\n";
            for (let item in inventoryData) {
                csv += `${item},${inventoryData[item].count},${inventoryData[item].lastTime}\n`;
            }
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", "jard_report_final.csv");
            link.click();
        }

        function resetAll() {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ")) {
                inventoryData = {};
                inventoryBody.innerHTML = "";
                status.innerText = "ğŸ”„ ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø².";
            }
        }

        init();
    </script>
</body>
</html>
