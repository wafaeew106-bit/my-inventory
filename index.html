<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø­Ù„ 2025 - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ù„Ø©</title>
    <style>
        /* ØªØµÙ…ÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù…Ø­Ù„Ùƒ */
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #0f172a; color: #f1f5f9; text-align: center; margin: 0; padding: 20px; }
        .jard-container { max-width: 900px; margin: auto; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        #camera-feed { position: relative; background: #000; border-radius: 20px; overflow: hidden; border: 4px solid #3b82f6; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        video { width: 100%; display: block; }
        .side-panel { background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid #334155; }
        .stat-card { background: #020617; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .count-value { font-size: 40px; color: #10b981; font-weight: bold; }
        #event-log { background: #020617; padding: 10px; height: 250px; overflow-y: auto; text-align: right; font-size: 13px; border-radius: 10px; color: #34d399; }
        .btn-action { background: #3b82f6; color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        #status-tag { color: #fbbf24; font-weight: bold; margin-bottom: 10px; display: block; }
    </style>
</head>
<body>

    <h2 style="color: #3b82f6;">ğŸ›’ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ (Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø³ØªÙ‚Ù„ 2025)</h2>
    <span id="status-tag">Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª âœ…</span>

    <div class="jard-container">
        <div id="camera-feed">
            <video id="webcam" autoplay playsinline muted></video>
            <!-- Ø·Ø¨Ù‚Ø© Ø°ÙƒÙŠØ© Ù„Ø±ØµØ¯ Ø§Ù„Ø­Ø±ÙƒØ© -->
            <div id="motion-detector" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></div>
        </div>

        <div class="side-panel">
            <div class="stat-card">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø¬Ø±ÙˆØ¯Ø©</div>
                <div class="count-value" id="total-items">0</div>
            </div>

            <button class="btn-action" onclick="resetJard()">Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ø±Ø¯</button>
            <button class="btn-action" style="background:#10b981;" onclick="downloadReport()">ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± (Excel)</button>

            <div id="event-log">
                <b>Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹:</b><br>
            </div>
        </div>
    </div>

    <script>
        // Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø§ ÙŠØ·Ù„Ø¨ Ø£ÙŠ Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ 404
        const video = document.getElementById('webcam');
        const totalDisplay = document.getElementById('total-items');
        const log = document.getElementById('event-log');
        let itemCount = 0;
        let isProcessing = false;

        // 1. ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙˆØ±Ø§Ù‹ ÙˆØ¨Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø§Øª
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
                // Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø±ØµØ¯ "Ø§Ù„ØªÙ…Ø±ÙŠØ±" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                setInterval(autoDetectMotion, 100); 
            } catch (err) {
                alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø§Ø¨ØªÙˆØ¨");
            }
        }

        // 2. ØªÙ‚Ù†ÙŠØ© "Ø±ØµØ¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±" (Motion Detection)
        // Ù‡Ø°Ù‡ Ø§Ù„ØªÙ‚Ù†ÙŠØ© ØªØ¹Ù…Ù„ ÙƒØ¨Ø¯ÙŠÙ„ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø«Ù‚ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ Ù„Ø¯ÙŠÙƒ
        let lastFrame;
        function autoDetectMotion() {
            if (isProcessing) return;

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth / 10;
            canvas.height = video.videoHeight / 10;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const currentFrame = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

            if (lastFrame) {
                let diff = 0;
                for (let i = 0; i < currentFrame.length; i += 4) {
                    diff += Math.abs(currentFrame[i] - lastFrame[i]);
                }
                
                // Ø¥Ø°Ø§ Ù…Ø± Ø´ÙŠØ¡ Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (ØªØºÙŠØ±Øª Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© Ø¨Ù†Ø³Ø¨Ø© ÙƒØ¨ÙŠØ±Ø©)
                if (diff > 50000) { 
                    handleCount();
                }
            }
            lastFrame = currentFrame;
        }

        function handleCount() {
            isProcessing = true;
            itemCount++;
            totalDisplay.innerText = itemCount;
            
            playBeep();
            addToLog();

            // Ù…Ù†Ø¹ Ø§Ù„Ø¹Ø¯ Ø§Ù„Ù…ØªÙƒØ±Ø± Ù„Ù†ÙØ³ Ø§Ù„Ù‚Ø·Ø¹Ø© (Ø§Ù†ØªØ¸Ø§Ø± Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©)
            setTimeout(() => { isProcessing = false; }, 1500);
        }

        function addToLog() {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.style.padding = "5px";
            entry.style.borderBottom = "1px solid #1e293b";
            entry.innerText = `[${time}] ØªÙ… ØªÙ…Ø±ÙŠØ± Ø¨Ù†Ø¯ Ø±Ù‚Ù… ${itemCount}`;
            log.prepend(entry);
        }

        function playBeep() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
            osc.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function downloadReport() {
            let data = "Ø§Ù„Ø±Ù‚Ù…,Ø§Ù„ÙˆÙ‚Øª,Ø§Ù„Ø­Ø§Ù„Ø©\n";
            const logs = log.innerText.split('\n');
            logs.forEach((line, index) => { if(line) data += `${index},${line},Ù…Ø¬Ø±ÙˆØ¯\n`; });
            const blob = new Blob([data], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'jard_report.csv';
            a.click();
        }

        function resetJard() {
            if(confirm("ØªØµÙÙŠØ± Ø§Ù„Ø¬Ø±Ø¯ØŸ")) {
                itemCount = 0;
                totalDisplay.innerText = 0;
                log.innerHTML = "<b>Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹:</b><br>";
            }
        }

        initCamera();
    </script>
</body>
</html>
