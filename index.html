<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ù„ 2025</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; text-align: center; margin: 0; padding: 10px; }
        .jard-container { max-width: 900px; margin: auto; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        #video-wrap { position: relative; background: #000; border-radius: 20px; overflow: hidden; border: 4px solid #3b82f6; }
        video { width: 100%; display: block; }
        .side-panel { background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid #334155; display: flex; flex-direction: column; }
        .stat-card { background: #020617; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .count-val { font-size: 45px; color: #10b981; font-weight: bold; }
        #log { background: #020617; padding: 10px; height: 300px; overflow-y: auto; text-align: right; font-size: 13px; border-radius: 10px; color: #34d399; border: 1px solid #334155; }
        .flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <h2 style="color: #3b82f6;">ğŸ›’ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ (Ø¥ØµØ¯Ø§Ø± 2025 Ø§Ù„Ø¹Ø§Ø¨Ø± Ù„Ù„Ø­Ø¸Ø±)</h2>
    <div style="background: #334155; padding: 5px; margin-bottom: 10px; font-size: 12px; color: #fbbf24;">
        Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù€ 404
    </div>

    <div class="jard-container">
        <div id="video-wrap">
            <video id="webcam" autoplay playsinline muted></video>
            <div id="flash-effect" class="flash"></div>
            <div style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.6); padding:5px; font-size:11px;">
                Ø§Ù„Ø±ØµØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: <span id="motion-stat" style="color:#10b981">Ù†Ø´Ø·</span>
            </div>
        </div>

        <div class="side-panel">
            <div class="stat-card">
                <div style="font-size:12px; color:#94a3b8;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù†ÙˆØ¯</div>
                <div class="count-val" id="total-qty">0</div>
            </div>

            <div id="log">
                <b>Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù„Ø­Ø¸ÙŠ:</b><br>
            </div>
            
            <button onclick="exportToCSV()" style="margin-top:15px; padding:12px; background:#10b981; border:none; color:white; border-radius:10px; cursor:pointer; font-weight:bold;">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
        </div>
    </div>

    <script>
        // ÙƒÙˆØ¯ Ø¬Ø§ÙØ§ Ø³ÙƒØ±ÙŠØ¨Øª ØµØ§ÙÙŠ 100% - Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø¥Ù†ØªØ±Ù†Øª
        const video = document.getElementById('webcam');
        const totalDisplay = document.getElementById('total-qty');
        const log = document.getElementById('log');
        const flash = document.getElementById('flash-effect');
        
        let count = 0;
        let isLock = false;
        let lastFrame;

        // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙˆØ±Ø§Ù‹
        async function startApp() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: 640, height: 480 } 
                });
                video.srcObject = stream;
                // ØªØ´ØºÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø±ØµØ¯ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø³ØªÙ‚Ù„
                requestAnimationFrame(analyzeMotion);
            } catch (err) {
                alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
            }
        }

        // 2. Ù…Ø­Ø±Ùƒ Ø±ØµØ¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± (Motion Detection)
        function analyzeMotion() {
            if (!isLock) {
                const canvas = document.createElement('canvas');
                canvas.width = 64; canvas.height = 48;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, 64, 48);
                const currentFrame = ctx.getImageData(0, 0, 64, 48).data;

                if (lastFrame) {
                    let diff = 0;
                    for (let i = 0; i < currentFrame.length; i += 4) {
                        diff += Math.abs(currentFrame[i] - lastFrame[i]);
                    }

                    // Ø¥Ø°Ø§ Ù…Ø± Ù…Ù†ØªØ¬ Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                    if (diff > 25000) { 
                        handleDetection();
                    }
                }
                lastFrame = currentFrame;
            }
            requestAnimationFrame(analyzeMotion);
        }

        // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ØµØ¯ (Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø§Ø³Ù… Ø¢Ù„ÙŠØ§Ù‹)
        function handleDetection() {
            isLock = true; // Ù‚ÙÙ„ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¹Ø¯ Ø§Ù„Ù…ØªÙƒØ±Ø± Ù„Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©
            
            // ØªØ£Ø«ÙŠØ± Ø§Ù„ÙÙ„Ø§Ø´ (Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©)
            flash.style.opacity = "0.7";
            setTimeout(() => flash.style.opacity = "0", 100);

            count++;
            totalDisplay.innerText = count;
            playBeep();

            // Ø¨Ù…Ø§ Ø£Ù† OCR Ù…Ø­Ø¬ÙˆØ¨ØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù…ÙŠØ²Ø© "Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª" Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ 
            // Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙÙˆØ± ØªÙ…Ø±ÙŠØ±Ù‡ (Ø­Ù„ Ø¹Ø¨Ù‚Ø±ÙŠ Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø±ÙˆØ§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠØ©)
            recordName();

            // ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ† Ù„Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
            setTimeout(() => { isLock = false; }, 2000);
        }

        function recordName() {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.style.padding = "5px";
            entry.style.borderBottom = "1px solid #1e293b";
            
            // ØªØ³Ø¬ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¨Ø¯Ø¦ÙŠ
            entry.innerHTML = `[${time}] Ø¬Ø±Ø¯ Ø¨Ù†Ø¯ Ø±Ù‚Ù… ${count} <span style="color:#fbbf24">(ØªÙ… Ø§Ù„Ø±ØµØ¯)</span>`;
            log.prepend(entry);
        }

        function playBeep() {
            const ac = new (window.AudioContext || window.webkitAudioContext)();
            const o = ac.createOscillator();
            const g = ac.createGain();
            o.connect(g); g.connect(ac.destination);
            o.frequency.value = 1000;
            g.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + 0.1);
            o.start(); o.stop(ac.currentTime + 0.1);
        }

        function exportToCSV() {
            let csv = "ID,Time,Status\n";
            csv += log.innerText.split('\n').map((l, i) => `${i},${l},OK`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'jard_2025.csv'; a.click();
        }

        startApp();
    </script>
</body>
</html>
