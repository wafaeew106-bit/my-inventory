<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø¨ØµØ±ÙŠ Ø§Ù„Ø°ÙƒÙŠ 2025</title>
    <style>
        :root { --primary: #3b82f6; --success: #10b981; --bg: #0f172a; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; }
        .wrapper { max-width: 1100px; margin: auto; display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        #cam-container { position: relative; border-radius: 20px; overflow: hidden; border: 3px solid var(--primary); background: #000; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        video { width: 100%; display: block; }
        .panel { background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid #334155; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--primary); background: #0f172a; color: white; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: 0.3s; }
        .btn-train { background: #f59e0b; color: white; }
        .inventory-log { background: #020617; padding: 15px; border-radius: 12px; height: 300px; overflow-y: auto; text-align: right; border: 1px solid #334155; }
        .item-card { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #1e293b; color: var(--success); }
        .status-pill { display: inline-block; padding: 5px 15px; border-radius: 50px; background: #334155; color: #fbbf24; font-size: 13px; margin-bottom: 10px; }
        #match-info { font-size: 11px; color: #94a3b8; }
    </style>
</head>
<body>

    <h2 style="color: var(--primary);">ğŸ›’ Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¬Ø±Ø¯ Ø¨Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¨ØµØ±ÙŠ (Ø¥ØµØ¯Ø§Ø± Ù…Ø­Ù„ÙŠ 100%)</h2>
    <div id="status" class="status-pill">Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ¹Ù„Ù… ÙˆØ§Ù„Ø¬Ø±Ø¯...</div>

    <div class="wrapper">
        <div id="cam-container">
            <video id="webcam" autoplay playsinline muted></video>
            <div id="flash" style="position:absolute; top:0; left:0; width:100%; height:100%; background:white; opacity:0; pointer-events:none;"></div>
        </div>

        <div class="panel">
            <h4>1. ØªØ¹Ø±ÙŠÙ Ø§Ù„ØµÙ†Ù (Ø¨ØµÙ…Ø© Ø¨ØµØ±ÙŠØ©)</h4>
            <input type="text" id="target-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù (Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„Ø¨Ø© ØªÙˆÙ†Ø©)">
            <button class="btn btn-train" onclick="captureSignature()">Ø­ÙØ¸ Ø¨ØµÙ…Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
            <div id="match-info">Ø³ÙŠØªÙ… Ø±Ø¨Ø· Ø´ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªÙˆØ¨</div>

            <hr style="border: 0.5px solid #334155; margin: 20px 0;">

            <h4>2. Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h4>
            <div id="log" class="inventory-log">
                <div style="color: #475569; text-align: center;">Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ…Ø±ÙŠØ±...</div>
            </div>
            
            <button class="btn" style="background: var(--success); color: white; margin-top: 15px;" onclick="exportCSV()">ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø±Ø¯</button>
        </div>
    </div>

    <script>
        // Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ØµØ±ÙŠØ© (Pixel Data) Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©
        const video = document.getElementById('webcam');
        const log = document.getElementById('log');
        const targetName = document.getElementById('target-name');
        const flash = document.getElementById('flash');
        
        let signatures = []; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ØµÙ…Ø§Øª { name: "Ø§Ø³Ù…", data: [Ø£Ù„ÙˆØ§Ù†] }
        let inventory = {};  // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯
        let isProcessing = false;
        let lastFrame;

        // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                requestAnimationFrame(analyze);
            } catch (e) { alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§"); }
        }

        // 2. ÙˆØ¸ÙŠÙØ© "Ø£Ø®Ø° Ø§Ù„Ø¨ØµÙ…Ø©" (Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ¹Ø±ÙŠÙ)
        function captureSignature() {
            if (targetName.value === "") { alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹!"); return; }
            
            const sig = getFrameSignature();
            signatures.push({ name: targetName.value, data: sig });
            
            if (!inventory[targetName.value]) inventory[targetName.value] = 0;
            
            showFlash("#f59e0b");
            document.getElementById('status').innerText = "âœ… ØªÙ… Ø­ÙØ¸ Ø¨ØµÙ…Ø©: " + targetName.value;
            targetName.value = ""; // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚Ù„ Ù„Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ù„ØµÙ†Ù Ø§Ù„ØªØ§Ù„ÙŠ
            updateUI();
        }

        // 3. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ø¨ØµØ±ÙŠØ© (Color Histogram)
        function getFrameSignature() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 10; tempCanvas.height = 10; // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙˆØ±Ø© Ù„Ù€ 100 Ù…Ù†Ø·Ù‚Ø©
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(video, 0, 0, 10, 10);
            return tempCtx.getImageData(0, 0, 10, 10).data;
        }

        // 4. Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±ØµØ¯ ÙˆØ§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        function analyze() {
            const currentData = getFrameSignature();

            if (lastFrame && !isProcessing && signatures.length > 0) {
                let motion = 0;
                for (let i = 0; i < currentData.length; i += 4) {
                    motion += Math.abs(currentData[i] - lastFrame[i]);
                }

                // Ø¥Ø°Ø§ Ø­Ø¯Ø« ØªÙ…Ø±ÙŠØ± (Ø­Ø±ÙƒØ©)
                if (motion > 8000) { 
                    findMatch(currentData);
                }
            }
            lastFrame = currentData;
            requestAnimationFrame(analyze);
        }

        // 5. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø¨ØµÙ…Ø© Ø¨ØµØ±ÙŠØ© Ù…Ø®Ø²Ù†Ø©
        function findMatch(currentData) {
            isProcessing = true;
            let bestMatch = null;
            let minDiff = Infinity;

            signatures.forEach(sig => {
                let diff = 0;
                for (let i = 0; i < currentData.length; i++) {
                    diff += Math.abs(currentData[i] - sig.data[i]);
                }
                if (diff < minDiff) {
                    minDiff = diff;
                    bestMatch = sig.name;
                }
            });

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ù‚ÙˆÙŠ (Ø¹ØªØ¨Ø© Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©)
            if (minDiff < 15000) {
                inventory[bestMatch]++;
                playBeep();
                showFlash("#10b981");
                updateUI();
            }

            setTimeout(() => { isProcessing = false; }, 1500);
        }

        function updateUI() {
            log.innerHTML = "";
            for (let name in inventory) {
                const row = document.createElement('div');
                row.className = 'item-card';
                row.innerHTML = `<span>${name}</span> <span>${inventory[name]}</span>`;
                log.prepend(row);
            }
        }

        function showFlash(color) {
            flash.style.background = color;
            flash.style.opacity = "0.6";
            setTimeout(() => flash.style.opacity = "0", 100);
        }

        function playBeep() {
            const ac = new AudioContext();
            const o = ac.createOscillator();
            o.connect(ac.destination);
            o.start(); o.stop(ac.currentTime + 0.1);
        }

        function exportCSV() {
            let csv = "Item,Count\n";
            for(let n in inventory) csv += `${n},${inventory[n]}\n`;
            const blob = new Blob([csv], { type: 'text/csv' });
            window.open(URL.createObjectURL(blob));
        }

        init();
    </script>
</body>
</html>
