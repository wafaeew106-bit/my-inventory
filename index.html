<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ‚Ø± 2025</title>
    <style>
        :root { --primary: #3b82f6; --success: #10b981; --dark: #0f172a; --panel: #1e293b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--dark); color: #f1f5f9; text-align: center; margin: 0; padding: 10px; }
        .main-container { max-width: 1000px; margin: auto; display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        @media (max-width: 800px) { .main-container { grid-template-columns: 1fr; } }
        #video-container { position: relative; background: #000; border-radius: 20px; overflow: hidden; border: 3px solid var(--primary); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        video { width: 100%; display: block; transform: scaleX(-1); } /* ØªØ¹ÙƒÙŠØ³ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© */
        .side-panel { background: var(--panel); padding: 20px; border-radius: 20px; border: 1px solid #334155; display: flex; flex-direction: column; height: 500px; }
        .status-pill { display: inline-block; padding: 10px 20px; border-radius: 50px; background: #334155; color: #fbbf24; font-weight: bold; margin-bottom: 15px; font-size: 14px; transition: all 0.3s; }
        .inventory-table { background: #020617; border-radius: 12px; flex-grow: 1; overflow-y: auto; border: 1px solid #334155; }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        th { background: #1e293b; color: #94a3b8; padding: 12px; font-size: 13px; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #1e293b; color: var(--success); font-weight: bold; font-size: 16px; }
        tr.new-hit { animation: highlight 1.5s ease-out; }
        @keyframes highlight { from { background: #064e3b; } to { background: transparent; } }
        .btn-export { background: var(--success); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; transition: opacity 0.1s; z-index: 10; }
    </style>
</head>
<body>

    <h2 style="color: var(--primary);">ğŸ›’ Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ø°ÙƒÙŠ <span style="font-size: 12px; color:#64748b;">V2.1 - 2025</span></h2>
    <div id="app-status" class="status-pill">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...</div>

    <div class="main-container">
        <div id="video-container">
            <video id="webcam" autoplay playsinline muted></video>
            <div id="flash-effect" class="flash"></div>
        </div>

        <div class="side-panel">
            <div style="font-size: 14px; color: #94a3b8; margin-bottom: 10px;">ğŸ“¦ Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ÙŠ:</div>
            <div class="inventory-table">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØµÙ†Ù</th>
                            <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                            <th>Ø¢Ø®Ø± Ø±ØµØ¯</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body"></tbody>
                </table>
            </div>
            <button class="btn-export" onclick="exportToCSV()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (CSV)</button>
            <button onclick="resetAll()" style="background:none; border:none; color:#f43f5e; margin-top:15px; cursor:pointer; font-size:12px; text-decoration: underline;">ØªØµÙÙŠØ± Ø§Ù„Ø¬Ø±Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const status = document.getElementById('app-status');
        const inventoryBody = document.getElementById('inventory-body');
        const flash = document.getElementById('flash-effect');
        
        let inventoryData = JSON.parse(localStorage.getItem('jard_data')) || {}; 
        let isListening = false;
        let lastFrameData;
        let recognition;

        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                status.innerText = "âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²! Ù…Ø±Ø± Ù…Ù†ØªØ¬Ø§Ù‹ Ø«Ù… Ø§Ù†Ø·Ù‚ Ø§Ø³Ù…Ù‡";
                setupVoice();
                renderTable(); // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
                requestAnimationFrame(checkMotion);
            } catch (err) {
                status.innerText = "âŒ Ø®Ø·Ø£: ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙˆØµÙˆÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†";
                console.error(err);
            }
        }

        function setupVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                status.innerText = "âŒ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ";
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'ar-EG';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                // Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø®Ø·Ø£: Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø¢Ù…Ù† Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (event.results && event.results[0] && event.results[0][0]) {
                    const itemName = event.results[0][0].transcript.trim();
                    if (itemName) {
                        processJard(itemName);
                    }
                }
            };

            recognition.onend = () => {
                isListening = false;
                if (status.innerText.includes("ğŸ¤")) {
                    status.innerText = "âœ… ØªÙ… Ø§Ù„Ø±ØµØ¯! Ù…Ø±Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØªØ§Ù„ÙŠ";
                    status.style.background = "#334155";
                }
            };

            recognition.onerror = (event) => {
                isListening = false;
                status.innerText = "âš ï¸ Ù„Ù… Ø£Ø³Ù…Ø¹Ùƒ Ø¬ÙŠØ¯Ø§Ù‹.. Ø­Ø§ÙˆÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
                status.style.background = "#334155";
                console.log("Speech Error:", event.error);
            };
        }

        function checkMotion() {
            if (!isListening && video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.width = 64; canvas.height = 48;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, 64, 48);
                const currentData = ctx.getImageData(0, 0, 64, 48).data;

                if (lastFrameData) {
                    let diff = 0;
                    for (let i = 0; i < currentData.length; i += 4) {
                        diff += Math.abs(currentData[i] - lastFrameData[i]);
                    }
                    if (diff > 15000) { // Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ©
                        startScan();
                    }
                }
                lastFrameData = currentData;
            }
            requestAnimationFrame(checkMotion);
        }

        function startScan() {
            if (isListening) return;
            isListening = true;
            
            // ØªØ£Ø«ÙŠØ± Ø§Ù„ÙÙ„Ø§Ø´ Ø§Ù„Ø¨ØµØ±ÙŠ
            flash.style.opacity = "0.5";
            setTimeout(() => flash.style.opacity = "0", 150);
            
            status.innerText = "ğŸ¤ Ø§Ø³Ù…Ø¹Ùƒ.. Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ";
            status.style.background = "#10b981";
            
            try { recognition.start(); } catch(e) { isListening = false; }
        }

        function processJard(name) {
            const time = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            
            // ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø²Ø§Ø¦Ø¯Ø© Ù…Ø«Ù„Ø§Ù‹ Ø£Ùˆ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª)
            const cleanName = name.replace(/^Ø§Ù„Ù€|^Ø§Ù„/g, '').trim();

            if (inventoryData[cleanName]) {
                inventoryData[cleanName].count++;
                inventoryData[cleanName].lastTime = time;
            } else {
                inventoryData[cleanName] = { count: 1, lastTime: time };
            }
            
            localStorage.setItem('jard_data', JSON.stringify(inventoryData));
            renderTable(cleanName);
        }

        function renderTable(highlightedName = null) {
            inventoryBody.innerHTML = "";
            const items = Object.keys(inventoryData).reverse(); // Ø§Ù„Ø£Ø­Ø¯Ø« ÙŠØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹

            items.forEach(name => {
                const row = document.createElement('tr');
                if (name === highlightedName) row.className = "new-hit";
                
                row.innerHTML = `
                    <td>${name}</td>
                    <td>${inventoryData[name].count}</td>
                    <td style="font-size:11px; color:#64748b;">${inventoryData[name].lastTime}</td>
                `;
                inventoryBody.appendChild(row);
            });
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "Ø§Ù„ØµÙ†Ù,Ø§Ù„ÙƒÙ…ÙŠØ©,Ø¢Ø®Ø± ÙˆÙ‚Øª Ø±ØµØ¯\n";
            
            Object.keys(inventoryData).forEach(name => {
                csvContent += `${name},${inventoryData[name].count},${inventoryData[name].lastTime}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Ø¬Ø±Ø¯_Ù…Ø­Ù„_${new Date().toLocaleDateString()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function resetAll() {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø±Ø¯ØŸ")) {
                inventoryData = {};
                localStorage.removeItem('jard_data');
                renderTable();
                status.innerText = "â™»ï¸ ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        window.onload = init;
    </script>
</body>
</html>
