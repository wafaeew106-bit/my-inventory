<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ - Ù‚Ø§Ø±ÙŠØ¡ Ø§Ù„ØµÙˆØª 2025</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; margin: 0; padding: 10px; }
        .jard-wrapper { max-width: 1000px; margin: auto; display: grid; grid-template-columns: 1fr 350px; gap: 15px; }
        #cam-container { position: relative; background: #000; border-radius: 20px; overflow: hidden; border: 3px solid #3b82f6; }
        video { width: 100%; display: block; }
        #status-msg { background: #1e293b; padding: 10px; border-radius: 10px; color: #fbbf24; font-weight: bold; margin-top: 10px; }
        .side-panel { background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid #334155; }
        .inventory-log { background: #020617; padding: 15px; height: 350px; overflow-y: auto; text-align: right; border-radius: 10px; border: 1px solid #334155; font-family: monospace; }
        .item-entry { color: #10b981; padding: 8px; border-bottom: 1px solid #1e293b; font-size: 14px; }
    </style>
</head>
<body>

    <h2 style="color: #3b82f6;">ğŸ›’ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠ (ØªØ³Ù…ÙŠØ© ØµÙˆØªÙŠØ©)</h2>
    <div id="status-msg">Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„. Ù…Ø±Ø± Ø§Ù„Ù…Ù†ØªØ¬...</div>

    <div class="jard-wrapper">
        <div id="cam-container">
            <video id="webcam" autoplay playsinline muted></video>
            <div id="flash" style="position:absolute; top:0; left:0; width:100%; height:100%; background:white; opacity:0; pointer-events:none;"></div>
        </div>

        <div class="side-panel">
             <div id="log" class="inventory-log">
                <div style="color: #475569; text-align: center;">Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„ØµÙˆØªÙŠ...</div>
            </div>
             <button onclick="exportCSV()" style="margin-top: 15px; width: 100%; padding: 12px; background: #10b981; border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: bold;">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
        </div>
    </div>

    <script>
        // Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¬Ø§ÙØ§ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„ØµØ§ÙÙŠØ© ÙˆÙ…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© ÙÙ‚Ø·
        const video = document.getElementById('webcam');
        const log = document.getElementById('log');
        const statusMsg = document.getElementById('status-msg');
        const flash = document.getElementById('flash');
        
        let inventory = {}; // { "Ø§Ù„Ø§Ø³Ù…": Ø§Ù„Ø¹Ø¯Ø¯ }
        let isProcessing = false;
        let lastFrame;
        let recognition; // Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ

        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                statusMsg.innerText = "âœ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„. Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ...";
                setupVoiceRecognition();
                requestAnimationFrame(analyzeMotion);
            } catch (e) { alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§"); }
        }

        function setupVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ar-EG,en-US'; // ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = function(event) {
                const speechToText = event.results[0][0].transcript;
                processItem(speechToText);
            };

            recognition.onspeechend = function() {
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø·Ù‚
                setTimeout(() => { isProcessing = false; statusMsg.innerText = "âœ… Ù…Ø±Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØªØ§Ù„ÙŠ"; }, 500);
            };

            recognition.onerror = function(event) {
                 statusMsg.innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ: ' + event.error;
                 setTimeout(() => { isProcessing = false; statusMsg.innerText = "âœ… Ù…Ø±Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØªØ§Ù„ÙŠ"; }, 1000);
            };
        }

        function analyzeMotion() {
            if (isProcessing) return;
            const canvas = document.createElement('canvas');
            canvas.width = 48; canvas.height = 36;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, 48, 36);
            const currentFrame = ctx.getImageData(0, 0, 48, 36).data;

            if (lastFrame) {
                let diff = 0;
                for (let i = 0; i < currentFrame.length; i += 4) {
                    diff += Math.abs(currentFrame[i] - lastFrame[i]);
                }
                if (diff > 10000) { // Ø­Ø¯Ø« ØªÙ…Ø±ÙŠØ±
                    handleDetection();
                }
            }
            lastFrame = currentFrame;
            requestAnimationFrame(analyzeMotion);
        }

        function handleDetection() {
            isProcessing = true;
            showFlash();
            playBeep();
            statusMsg.innerText = "ğŸ”Š ØªÙ… Ø§Ù„Ø±ØµØ¯! Ù‚Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù†...";
            recognition.start(); // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØµÙˆØªÙƒ
        }

        function processItem(name) {
             if (!inventory[name]) inventory[name] = 0;
             inventory[name]++;

             const time = new Date().toLocaleTimeString();
             const entry = document.createElement('div');
             entry.className = 'item-entry';
             entry.innerHTML = `<b>[${time}]</b> ØªÙ… Ø¬Ø±Ø¯: <span style="color:#fbbf24; font-weight:bold;">${name}</span> (Ø§Ù„Ø¹Ø¯Ø¯: ${inventory[name]})`;
             log.prepend(entry);
             updateUI();
        }

        function updateUI() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶Ø±ÙˆØ±Ø©
        }

        function showFlash() {
            flash.style.opacity = "0.6";
            setTimeout(() => { flash.style.opacity = "0"; }, 100);
        }

        function playBeep() {
            const ac = new (window.AudioContext || window.webkitAudioContext)();
            const o = ac.createOscillator();
            o.connect(ac.destination);
            o.start(); o.stop(ac.currentTime + 0.1);
        }

        function exportCSV() {
            let csv = "Ø§Ù„ØµÙ†Ù,Ø§Ù„ÙƒÙ…ÙŠØ©\n";
            for(let name in inventory) csv += `${name},${inventory[name]}\n`;
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'jard_voice_report.csv'; a.click();
        }

        init();
    </script>
</body>
</html>
